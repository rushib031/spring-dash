package com.example.vuln_dashboard;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import java.util.List;
import jakarta.validation.Valid;

@RestController
@RequestMapping("/api/vulnerabilities") // Good practice to use /api prefix
public class VulnerabilityController {

    private final VulnerabilityRepository repository;
    private final RateLimitService rateLimitService;

    public VulnerabilityController(VulnerabilityRepository repository, RateLimitService rateLimitService) {
        this.repository = repository;
        this.rateLimitService = rateLimitService;
    }

    @GetMapping
    public List<Vulnerability> getAll() {
        return repository.findAll(); // Fetches all rows from the DB
    }

    @GetMapping("/search")
    public List<Vulnerability> getBySeverity(@RequestParam String severity) {
        return repository.findBySeverity(severity);
    }

    @PostMapping
    public ResponseEntity<?> create(@Valid @RequestBody Vulnerability vuln) {
        if (rateLimitService.tryConsume()) {
            return ResponseEntity.ok(repository.save(vuln));
        } else {
            return ResponseEntity.status(HttpStatus.TOO_MANY_REQUESTS).body("Rate limit exceeded!");
        }
    }

    @DeleteMapping("/{id}")
    public void deleteVulnerability(@PathVariable Long id) {
        repository.deleteById(id);
    }
}